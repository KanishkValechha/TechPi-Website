---
interface Props {
  images: string[];
}

const { images } = Astro.props;
---
<div class="product-gallery">
  <!-- Main Image -->
  <div class="relative overflow-hidden rounded-lg mb-4 aspect-video bg-gray-100">
    <div class="absolute inset-0 animate-pulse" id="imagePlaceholder"></div>
    <img
      id="mainImage"
      src={images[0]}
      alt="Product"
      class="w-full h-full object-cover opacity-0 transition-all duration-500"
      onload="this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('opacity-0')"
    />
    
    <!-- Zoom Lens -->
    <div 
      id="zoomLens"
      class="absolute hidden bg-white/10 border border-white/20 pointer-events-none transition-all duration-100"
    ></div>
    
    <!-- Zoomed Result -->
    <div 
      id="zoomResult"
      class="absolute top-0 right-0 w-[400px] h-[400px] hidden bg-white rounded-lg shadow-2xl overflow-hidden border-4 border-white"
    ></div>
  </div>
  
  <!-- Thumbnails -->
  <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
    {images.map((image, index) => (
      <button
        class="thumbnail-btn relative aspect-square rounded-lg overflow-hidden cursor-pointer group"
        data-image={image}
      >
        <div class="absolute inset-0 bg-gray-100 animate-pulse"></div>
        <img
          src={image}
          alt={`Product thumbnail ${index + 1}`}
          class="w-full h-full object-cover opacity-0 transition-all duration-500 group-hover:scale-110"
          onload="this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('opacity-0')"
        />
        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-300"></div>
      </button>
    ))}
  </div>
</div>

<script>
  function initGallery() {
    const mainImage = document.getElementById('mainImage') as HTMLImageElement;
    const thumbnails = document.querySelectorAll('.thumbnail-btn');
    const zoomLens = document.getElementById('zoomLens');
    const zoomResult = document.getElementById('zoomResult');
    
    let isZooming = false;

    // Thumbnail click handling
    thumbnails.forEach(btn => {
      btn.addEventListener('click', () => {
        const newSrc = btn.getAttribute('data-image');
        if (newSrc && mainImage.src !== newSrc) {
          mainImage.classList.add('opacity-0');
          setTimeout(() => {
            mainImage.src = newSrc;
            mainImage.classList.remove('opacity-0');
          }, 300);
        }
      });
    });

    // Zoom functionality
    if (mainImage && zoomLens && zoomResult) {
      const zoomLevel = 2;

      function getMousePosition(e: MouseEvent) {
        const rect = mainImage.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }

      function moveLens(pos: { x: number, y: number }) {
        const lensSize = 100;
        let x = pos.x - lensSize / 2;
        let y = pos.y - lensSize / 2;

        // Constrain lens position
        x = Math.max(0, Math.min(x, mainImage.offsetWidth - lensSize));
        y = Math.max(0, Math.min(y, mainImage.offsetHeight - lensSize));

        // Update lens position
        zoomLens.style.left = `${x}px`;
        zoomLens.style.top = `${y}px`;
        zoomLens.style.width = `${lensSize}px`;
        zoomLens.style.height = `${lensSize}px`;

        // Update zoomed image
        zoomResult.style.backgroundImage = `url(${mainImage.src})`;
        zoomResult.style.backgroundSize = `${mainImage.width * zoomLevel}px ${mainImage.height * zoomLevel}px`;
        zoomResult.style.backgroundPosition = `-${x * zoomLevel}px -${y * zoomLevel}px`;
      }

      mainImage.addEventListener('mouseenter', () => {
        if (window.innerWidth >= 1024) { // Only on desktop
          isZooming = true;
          zoomLens.classList.remove('hidden');
          zoomResult.classList.remove('hidden');
        }
      });

      mainImage.addEventListener('mouseleave', () => {
        isZooming = false;
        zoomLens.classList.add('hidden');
        zoomResult.classList.add('hidden');
      });

      mainImage.addEventListener('mousemove', (e) => {
        if (isZooming) {
          const pos = getMousePosition(e);
          moveLens(pos);
        }
      });
    }
  }

  // Initialize on page load
  initGallery();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initGallery);
</script>